global
  chroot  /var/lib/haproxy
daemon
group  haproxy
log  <%= @ip -%> local0
maxconn  4000
pidfile  /var/run/haproxy.pid
stats  socket /var/lib/haproxy/stats
user  haproxy

defaults
log  global
maxconn  8000
option  redispatch
retries  3
stats  enable
timeout  http-request 10s
timeout  queue 1m
timeout  connect 10s
timeout  client 1m
timeout  server 1m
timeout  check 10s

<% if @listeners.length > 0 -%>
<% @listeners.each do |listener| -%>
listen <%= listener[0] %>
bind <%= listener[0]['ip'] -%>:<%= listener[0]['port'] -%> ssl crt /etc/ssl/certs/<%= @fqdn -%>.pem
mode <%= listener[0]['mode'] %>
balance roundrobin
option tcplog
server <%= listener[0]['server_fqdn'] -%> <%= listener[0]['server_ip'] -%> check
<% end -%>
<% end -%>
